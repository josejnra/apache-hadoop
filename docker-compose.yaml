version: '3.7'

networks: 
  hadoop:

services:
 
  namenode:
    image: hadoop:3.3.1
    build: 
      context: .
    container_name: namenode
    ports: 
      - 9870:9870 # HDFS UI
      - 9868:9868 # Secondary Namenode port
    volumes: 
      - ./conf/core-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/core-site.xml
      - ./conf/hdfs-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/hdfs-site.xml
      - ./conf/mapred-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/mapred-site.xml
      - ./conf/yarn-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/yarn-site.xml
    networks: 
      - hadoop
    command:
      - "-c"
      - |
        echo "Starting ssh service..."
        service ssh start 

        echo "Formating the filesystem..."
        hdfs namenode -format

        echo "Starting Namenode daemon..."
        hdfs --config /home/hadoop/hadoop-3.3.1/etc/hadoop --hostnames localhost --daemon start namenode
        #/home/hadoop/hadoop-$${HADOOP_VERSION}/sbin/start-dfs.sh

        echo "Making the HDFS directories required to execute MapReduce jobs..."
        hdfs dfs -mkdir /user
        hdfs dfs -mkdir /user/$$(whoami)

        #echo "echo Coping the input files into the distributed filesystem..."
        #bin/hdfs dfs -put etc/hadoop input

        echo "Starting ResourceManager daemon and NodeManager daemon..."
        #/home/hadoop/hadoop-$${HADOOP_VERSION}/sbin/start-yarn.sh

        sleep infinity & wait


  datanode:
    image: hadoop:3.3.1
    build: 
      context: .
    container_name: datanode
    ports: 
      - 9864:9864 # Datanode port
    volumes: 
      - ./conf/core-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/core-site.xml
      - ./conf/hdfs-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/hdfs-site.xml
      - ./conf/mapred-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/mapred-site.xml
      - ./conf/yarn-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/yarn-site.xml
    networks: 
      - hadoop
    command:
      - "-c"
      - |
        echo "Starting ssh service..."
        service ssh start 

        echo "Formating the filesystem..."
        hdfs datanode -regular

        echo "Starting DataNode daemon..."
        hdfs --config /home/hadoop/hadoop-3.3.1/etc/hadoop --hostnames localhost --daemon start datanode

        echo "Making the HDFS directories required to execute MapReduce jobs..."
        hdfs dfs -mkdir /user
        hdfs dfs -mkdir /user/$$(whoami)

        sleep infinity & wait
    depends_on: 
      - namenode

  resourcemanager:
    image: hadoop:3.3.1
    build: 
      context: .
    container_name: resourcemanager
    ports: 
      - 8088:8088 # Resource Manager UI
      - 8042:8042
    volumes: 
      - ./conf/mapred-site.xml:/home/hadoop/hadoop-3.3.1/etc/hadoop/mapred-site.xml
    networks: 
      - hadoop
    command:
      - "-c"
      - |
        echo "Starting ssh service..."
        service ssh start 

        echo "Starting ResourceManager daemon and NodeManager daemon..."
        yarn --config /home/hadoop/hadoop-3.3.1/etc/hadoop --hostnames localhost --daemon start resourcemanager
        yarn --config /home/hadoop/hadoop-3.3.1/etc/hadoop --daemon start nodemanager
        # yarn --config /home/hadoop/hadoop-3.3.1/etc/hadoop --hostnames localhost --daemon start proxyserver
        #/home/hadoop/hadoop-$${HADOOP_VERSION}/sbin/start-yarn.sh

        sleep infinity & wait
